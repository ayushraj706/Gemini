<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseKey AI</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Open Sans", sans-serif; }
        body { background-color: #131314; color: #fff; height: 100vh; display: flex; flex-direction: column; }
        
        #login-screen { position: fixed; inset: 0; background: #131314; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .btn { padding: 12px 24px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; }
        .google-btn { background: #fff; color: #333; display: flex; gap: 10px; align-items: center; }
        .otp-btn { background: transparent; border: 1px solid #555; color: #aaa; }
        .input-box { background: #1E1F20; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        
        #app-screen { display: none; flex-direction: column; height: 100%; }
        .chats { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .message { padding: 10px 15px; border-radius: 10px; max-width: 85%; }
        .user-msg { align-self: flex-end; background: #282A2C; }
        .bot-msg { align-self: flex-start; color: #E3E3E3; }
        .prompt { padding: 15px; background: #131314; }
        input { background: #1E1F20; border: none; color: white; padding: 10px; width: 100%; border-radius: 20px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>BaseKey AI</h1>
        <button class="btn google-btn" onclick="loginWithGoogle()">Sign in with Google</button>
        <button class="btn otp-btn" onclick="showOtpForm()">Login with OTP</button>
        
        <div id="otp-form" style="display:none; flex-direction:column; gap:10px;">
            <input id="emailInput" class="input-box" placeholder="Email Address">
            <button class="btn" style="background:#a8c7fa;" onclick="sendOtp()">Send OTP</button>
            
            <div id="verify-section" style="display:none;">
                <input id="otpInput" class="input-box" placeholder="Enter OTP">
                <button class="btn" style="background:#34a853; color:white;" onclick="verifyOtp()">Verify</button>
            </div>
            <p id="status" style="color:red; font-size:12px;"></p>
        </div>
    </div>

    <div id="app-screen">
        <div class="chats" id="chatContainer"></div>
        <div class="prompt">
            <form onsubmit="handleChat(event)"><input id="promptInput" placeholder="Message..." required autocomplete="off"></form>
        </div>
    </div>

    <script>
        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyCDmDsi_JMQgx_QO4p8bnvfh-vKdN4Bmk8",
            authDomain: "success-points.firebaseapp.com",
            projectId: "success-points",
            storageBucket: "success-points.firebasestorage.app",
            messagingSenderId: "51177935348",
            appId: "1:51177935348:web:33fc4a6810790a3cbd29a1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(u => {
            if(u) { currentUser = u; document.getElementById("login-screen").style.display="none"; document.getElementById("app-screen").style.display="flex"; loadChats(); }
            else { document.getElementById("login-screen").style.display="flex"; document.getElementById("app-screen").style.display="none"; }
        });

        function loginWithGoogle() {
            const p = new firebase.auth.GoogleAuthProvider();
            p.setCustomParameters({ client_id: "51177935348-vcl2gvtlnqittjra8emmtuehrvifj02u.apps.googleusercontent.com" });
            auth.signInWithPopup(p).catch(e => alert(e.message));
        }

        function showOtpForm() { document.getElementById("otp-form").style.display="flex"; }

        // --- OTP LOGIC (Updated Path) ---
        async function sendOtp() {
            const email = document.getElementById("emailInput").value;
            const res = await fetch('/api/index', { // Changed to /api/index
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: 'send-otp', email: email })
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById("verify-section").style.display="block";
                document.getElementById("status").innerText="OTP Sent!";
            } else {
                document.getElementById("status").innerText=data.error;
            }
        }

        async function verifyOtp() {
            const email = document.getElementById("emailInput").value;
            const otp = document.getElementById("otpInput").value;
            const res = await fetch('/api/index', { // Changed to /api/index
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: 'verify-otp', email: email, otp: otp })
            });
            const data = await res.json();
            if(data.success) {
                await auth.signInAnonymously(); // Fake login for UI
            } else {
                alert("Invalid OTP");
            }
        }

        // --- CHAT LOGIC ---
        async function handleChat(e) {
            e.preventDefault();
            const txt = document.getElementById("promptInput").value;
            if(!txt) return;
            document.getElementById("promptInput").value="";
            addMsg(txt, true);
            
            try {
                const res = await fetch('/api/index', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ question: txt }) // Normal chat request
                });
                const data = await res.json();
                if(data.answer) addMsg(data.answer, false);
            } catch(err) { addMsg("Error: " + err.message, false); }
        }

        function addMsg(txt, isUser) {
            const d = document.createElement("div");
            d.className = `message ${isUser ? 'user-msg' : 'bot-msg'}`;
            d.innerHTML = marked.parse(txt);
            document.getElementById("chatContainer").appendChild(d);
        }

        function loadChats() {
            if(!currentUser) return;
            db.collection("users").doc(currentUser.uid).collection("chats").orderBy("timestamp").get().then(s => {
                s.forEach(d => addMsg(d.data().text, d.data().isUser));
            });
        }
    </script>
</body>
</html>


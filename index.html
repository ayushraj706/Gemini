<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BotKey AI</title>
    <meta name="theme-color" content="#131314">
    
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- DESIGN (CSS) --- */
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Open Sans", sans-serif; }
        
        body { background-color: #131314; color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #131314; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 20px;
        }
        .google-btn {
            background: #ffffff; color: #333; padding: 12px 24px;
            border-radius: 30px; border: none; font-weight: 600; font-size: 16px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            transition: transform 0.2s;
        }
        .google-btn:active { transform: scale(0.95); }
        .google-btn img { width: 24px; }

        /* APP SCREEN (Hidden initially) */
        #app-screen { display: none; flex-direction: column; height: 100%; }

        /* Navbar */
        .navbar {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; background: #131314;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; }
        .logout-btn { color: #ff6b6b; cursor: pointer; font-size: 1.5rem; }

        /* Header */
        .header { padding: 20px; text-align: center; margin-top: 5vh; transition: opacity 0.3s; }
        .header h1 {
            background: linear-gradient(to right, #4a90e2, #a355b9, #ff6b6b);
            -webkit-background-clip: text; color: transparent;
            font-size: 2.5rem; margin-bottom: 5px; font-weight: 600;
        }

        /* Chat Area */
        .chats { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 20px; max-width: 800px; margin: 0 auto; width: 100%; }
        .message { display: flex; gap: 10px; max-width: 100%; align-items: flex-start; }
        .user-msg { flex-direction: row-reverse; }
        .message__text { background: transparent; line-height: 1.6; font-size: 16px; color: #E3E3E3; max-width: 85%; word-wrap: break-word; }
        .user-msg .message__text { background: #282A2C; padding: 10px 15px; border-radius: 20px 4px 20px 20px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; flex-shrink: 0; margin-top: 2px; }

        /* Input */
        .prompt { position: fixed; bottom: 0; left: 0; right: 0; background: #131314; padding: 15px; }
        .prompt__wrapper {
            background: #1E1F20; border-radius: 30px; display: flex; align-items: center; padding: 8px 20px;
            max-width: 800px; margin: 0 auto; border: 1px solid #444746;
        }
        input { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 16px; outline: none; }
        button { background: transparent; border: none; color: white; font-size: 1.5rem; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="font-size: 2rem;">BotKey AI</h1>
        <p style="color: #aaa;">Please login to continue</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
            Sign in with Google
        </button>
    </div>

    <div id="app-screen">
        <nav class="navbar">
            <div class="user-info">
                <img id="userPic" src="" alt="">
                <span id="userName" style="font-size: 14px; font-weight: 600;">User</span>
            </div>
            <div style="display: flex; gap: 15px;">
                <i class='bx bx-plus-circle logout-btn' style="color: #a8c7fa;" onclick="clearScreen()" title="New Chat"></i>
                <i class='bx bx-log-out logout-btn' onclick="logout()" title="Logout"></i>
            </div>
        </nav>

        <div class="header" id="headerSection">
            <h1>Hello, Friend</h1>
            <h2>How can I help you today?</h2>
        </div>

        <div class="chats" id="chatContainer"></div>

        <div class="prompt">
            <form onsubmit="handleChat(event)">
                <div class="prompt__wrapper">
                    <input type="text" id="promptInput" placeholder="Message BotKey..." required autocomplete="off">
                    <button type="submit"><i class='bx bx-send'></i></button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION (Aapka Data) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCDmDsi_JMQgx_QO4p8bnvfh-vKdN4Bmk8",
            authDomain: "success-points.firebaseapp.com",
            projectId: "success-points",
            storageBucket: "success-points.firebasestorage.app",
            messagingSenderId: "51177935348",
            appId: "1:51177935348:web:33fc4a6810790a3cbd29a1",
            measurementId: "G-64DR1TSTKY"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. AUTHENTICATION LOGIC ---
        let currentUser = null;

        auth.onAuthStateChanged((user) => {
            if (user) {
                // User Logged In
                currentUser = user;
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("app-screen").style.display = "flex";
                
                // Set User Details
                document.getElementById("userName").innerText = user.displayName.split(" ")[0]; // First Name
                document.getElementById("userPic").src = user.photoURL;

                // Load Old Chats
                loadChats();
            } else {
                // User Logged Out
                currentUser = null;
                document.getElementById("login-screen").style.display = "flex";
                document.getElementById("app-screen").style.display = "none";
            }
        });

                function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Ye line "BaseKey" wala naam aur logo layegi
            provider.setCustomParameters({
                client_id: "51177935348-vcl2gvtlnqittjra8emmtuehrvifj02u.apps.googleusercontent.com"
            });

            auth.signInWithPopup(provider).catch((error) => {
                alert("Login Error: " + error.message);
            });
                }
        

        function logout() {
            auth.signOut();
        }

        // --- 3. CHAT LOGIC WITH DATABASE ---
        const chatContainer = document.getElementById("chatContainer");
        const headerSection = document.getElementById("headerSection");
        const promptInput = document.getElementById("promptInput");

        // Save Message to Firestore
        function saveMessage(text, isUser) {
            if (!currentUser) return;
            
            db.collection("users").doc(currentUser.uid).collection("chats").add({
                text: text,
                isUser: isUser,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Load Messages from Firestore
        function loadChats() {
            if (!currentUser) return;

            db.collection("users").doc(currentUser.uid).collection("chats")
            .orderBy("timestamp", "asc")
            .get().then((snapshot) => {
                if (!snapshot.empty) {
                    headerSection.style.display = 'none'; // Hide header if chats exist
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        addMessageToUI(data.text, data.isUser, false);
                    });
                }
            });
        }

        // Handle Send
        async function handleChat(e) {
            e.preventDefault();
            const text = promptInput.value.trim();
            if(!text) return;

            // 1. Show User Message
            headerSection.style.display = 'none';
            addMessageToUI(text, true);
            saveMessage(text, true); // Save to DB
            promptInput.value = '';
            
            // 2. Loading...
            const loadingId = addMessageToUI("Thinking...", false, true);

            try {
                // 3. Call Vercel API
                const res = await fetch('/api/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: text })
                });

                const data = await res.json();
                
                // 4. Show Bot Message
                document.getElementById(loadingId).remove();
                if(data && data.answer) {
                    addMessageToUI(data.answer, false);
                    saveMessage(data.answer, false); // Save to DB
                } else {
                    addMessageToUI("Error: No answer.", false);
                }

            } catch (err) {
                document.getElementById(loadingId).remove();
                addMessageToUI("Error: " + err.message, false);
            }
        }

        // Helper to add message HTML
        function addMessageToUI(text, isUser, isLoading=false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user-msg' : 'bot-msg'}`;
            div.id = 'msg-' + Date.now();
            
            const botIcon = "https://cdn-icons-png.flaticon.com/512/4712/4712027.png";
            // User photo from Google Login
            const userIcon = currentUser ? currentUser.photoURL : "https://cdn-icons-png.flaticon.com/512/1144/1144760.png";

            const content = (isUser || isLoading) ? text : marked.parse(text);

            div.innerHTML = `
                ${!isUser ? `<img src="${botIcon}" class="avatar">` : ''}
                <div class="message__text">${content}</div>
                ${isUser ? `<img src="${userIcon}" class="avatar">` : ''}
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div.id;
        }

        // Clear Screen (Visual Only)
        function clearScreen() {
            chatContainer.innerHTML = '';
            headerSection.style.display = 'block';
        }
    </script>
</body>
</html>
